{% extends "base.html" %}
{% block content %}
  <section>
    <div class="flex items-end justify-between gap-3">
      <div>
        <h2 class="text-2xl font-semibold">Reports</h2>
        <p class="muted text-sm mt-1">选择一份报告，在下方直接预览（iframe）。</p>
      </div>
      <div class="flex gap-2">
        <button id="refresh" class="btn rounded-lg px-3 py-2 text-sm">Refresh</button>
        <a id="open" class="btn rounded-lg px-3 py-2 text-sm" target="_blank" href="#">Open</a>
      </div>
    </div>

    <div class="mt-5 grid grid-cols-1 lg:grid-cols-[320px_1fr] gap-4">
      <div class="card rounded-2xl p-4">
        <div class="muted text-xs mb-2">Available</div>
        <select id="report" class="input w-full rounded-xl px-3 py-2">
          <option>Loading...</option>
        </select>
        <div id="meta" class="muted text-xs mt-3"></div>
        <div class="muted text-xs mt-3">
          直链会走 <code>/output/...</code>，默认屏蔽 <code>.db</code> 等文件类型。
        </div>
      </div>

      <div class="card rounded-2xl overflow-hidden">
        <iframe id="frame" class="w-full h-[78vh] bg-white" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </section>

  <script>
    const reportSelect = document.getElementById('report');
    const frame = document.getElementById('frame');
    const meta = document.getElementById('meta');
    const openBtn = document.getElementById('open');

    function fmtBytes(bytes) {
      if (!bytes && bytes !== 0) return '-';
      const units = ['B','KB','MB','GB'];
      let i = 0; let v = bytes;
      while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
      return v.toFixed(i === 0 ? 0 : 1) + ' ' + units[i];
    }

    function fmtTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    async function loadReports(pickLatest = true) {
      const r = await fetch('/api/reports');
      if (!r.ok) throw new Error('Failed to load reports');
      const items = await r.json();

      reportSelect.innerHTML = '';
      if (!items.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No reports found';
        reportSelect.appendChild(opt);
        return;
      }

      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = it.relpath;
        opt.textContent = it.label;
        opt.dataset.mtime = it.mtime;
        opt.dataset.size = it.size;
        reportSelect.appendChild(opt);
      }

      if (pickLatest) reportSelect.selectedIndex = 0;
      applySelection();
    }

    function applySelection() {
      const relpath = reportSelect.value;
      if (!relpath) return;
      const opt = reportSelect.selectedOptions[0];
      const url = '/output/' + relpath;
      frame.src = url;
      openBtn.href = url;
      meta.textContent = `Updated: ${fmtTime(Number(opt.dataset.mtime))} · Size: ${fmtBytes(Number(opt.dataset.size))}`;
    }

    reportSelect.addEventListener('change', applySelection);
    document.getElementById('refresh').addEventListener('click', () => loadReports(false));

    loadReports(true).catch(err => {
      reportSelect.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Error loading reports';
      reportSelect.appendChild(opt);
      meta.textContent = String(err);
    });
  </script>
{% endblock %}

